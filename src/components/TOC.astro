---
interface TocItem {
    id: string;
    label: string;
}

interface Props {
    items: TocItem[];
}

const { items } = Astro.props;
---

<aside class="hidden lg:block w-64 flex-shrink-0">
    <div class="sticky top-24 space-y-6">
        <nav aria-label="Sisällysluettelo" class="space-y-1">
            <h2 class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-text-dim mb-3">Sisällys</h2>
            {items.map(item => (
                <a
                    href={`#${item.id}`}
                    class="toc-link block py-2 pl-4 text-sm text-slate-600 dark:text-text-dim hover:text-primary border-l-2 border-transparent transition-colors"
                >
                    {item.label}
                </a>
            ))}
        </nav>

        <!-- Sidebar CTA -->
        <div class="rounded-xl bg-primary/10 dark:bg-primary/20 p-5 border border-primary/20">
            <h3 class="font-bold text-sm mb-2">Etsitkö koulutusta?</h3>
            <p class="text-xs text-slate-600 dark:text-text-dim mb-3">
                Selaa hyväksyttyjä koulutuksen tarjoajia.
            </p>
            <a href="#" class="inline-flex items-center text-xs font-bold text-primary hover:text-primary-hover transition-colors">
                Selaa kursseja
                <svg class="ml-1 w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M5 12h14"/>
                    <path d="m12 5 7 7-7 7"/>
                </svg>
            </a>
        </div>
    </div>
</aside>

<script>
    const tocLinks = document.querySelectorAll('.toc-link');
    const sections: { id: string; element: Element; link: Element }[] = [];

    // Gather sections that correspond to TOC links
    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const section = document.querySelector(href);
            if (section) {
                sections.push({
                    id: href.substring(1),
                    element: section,
                    link: link
                });
            }
        }
    });

    function updateTocHighlight() {
        if (sections.length === 0) return;

        const scrollPosition = window.scrollY + 150; // Offset for sticky header

        let currentSection = sections[0];

        for (const section of sections) {
            if ((section.element as HTMLElement).offsetTop <= scrollPosition) {
                currentSection = section;
            }
        }

        tocLinks.forEach(link => {
            link.classList.remove('active');
        });

        if (currentSection && currentSection.link) {
            currentSection.link.classList.add('active');
        }
    }

    if (sections.length > 0) {
        // Use passive listener for better scroll performance
        window.addEventListener('scroll', updateTocHighlight, { passive: true });
        // Initial highlight
        updateTocHighlight();
    }

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            const href = (this as HTMLAnchorElement).getAttribute('href');
            if (href === '#') return;

            const target = document.querySelector(href!);
            if (target) {
                e.preventDefault();

                // Check if user prefers reduced motion
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

                if (prefersReducedMotion) {
                    target.scrollIntoView();
                } else {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }

                // Update URL without scrolling
                history.pushState(null, '', href);

                // Set focus for accessibility
                (target as HTMLElement).setAttribute('tabindex', '-1');
                (target as HTMLElement).focus({ preventScroll: true });
            }
        });
    });
</script>
